# 密码错误限制功能说明

## 功能概述

为了增强系统安全性，智能OA系统实现了登录失败次数限制功能。当用户连续输入错误密码达到一定次数时，系统会自动锁定账户，防止暴力破解攻击。

## 功能特性

### 1. 失败次数限制
- **最大失败次数**: 5次
- **计数范围**: 1小时内
- **重置机制**: 登录成功后自动清除失败次数

### 2. 账户锁定机制
- **锁定触发**: 连续失败5次后自动锁定
- **锁定时间**: 30分钟
- **自动解锁**: 锁定时间到期后自动解锁

### 3. 安全提示
- **剩余尝试次数**: 每次失败后显示剩余尝试次数
- **锁定状态提示**: 显示账户锁定状态和剩余锁定时间
- **详细错误信息**: 提供清晰的错误提示信息

## 技术实现

### 1. 存储机制
使用Redis存储登录失败次数和账户锁定状态：

```java
// 失败次数存储
String key = "login_attempts:" + username;
redisTemplate.opsForValue().set(key, attempts, Duration.ofHours(1));

// 账户锁定状态存储
String lockKey = "account_locked:" + username;
redisTemplate.opsForValue().set(lockKey, true, Duration.ofMinutes(30));
```

### 2. 核心逻辑

#### 登录流程
1. **检查用户是否存在**
   - 首先验证用户名是否在数据库中存在
   - 如果用户不存在，增加失败次数并返回错误

2. **检查用户状态**
   - 验证用户账户是否处于启用状态
   - 如果账户被禁用，直接拒绝登录

3. **检查账户锁定状态**
   - 如果账户被锁定，直接拒绝登录
   - 显示剩余锁定时间

4. **检查失败次数**
   - 如果达到最大失败次数，锁定账户
   - 显示相应的错误信息

5. **尝试认证**
   - 使用Spring Security进行密码验证
   - 捕获认证异常

6. **处理结果**
   - 成功：清除失败次数，返回JWT令牌
   - 失败：增加失败次数，返回错误信息

#### 失败处理
```java
catch (BadCredentialsException e) {
    // 密码错误
    incrementFailedLoginAttempts(username);
    
    int remainingAttempts = MAX_LOGIN_ATTEMPTS - getFailedLoginAttempts(username);
    String message = remainingAttempts > 0 
        ? "用户名或密码错误，还剩 " + remainingAttempts + " 次尝试机会"
        : "登录失败次数过多，账户将被锁定 " + LOCK_DURATION_MINUTES + " 分钟";
    
    return ResponseEntity.badRequest().body(Result.error(message));
}
```

## API接口

### 登录接口
```
POST /api/auth/login
Content-Type: application/json

{
    "username": "admin",
    "password": "admin123"
}
```

### 响应示例

#### 成功登录
```json
{
    "success": true,
    "message": "登录成功",
    "data": {
        "token": "eyJhbGciOiJIUzUxMiJ9...",
        "user": {
            "id": 1,
            "username": "admin",
            "realName": "系统管理员",
            "email": "admin@smartoa.com",
            "phone": "13800138001",
            "deptId": 1,
            "deptName": "系统管理部",
            "status": 1,
            "roles": ["ROLE_ADMIN"]
        }
    }
}
```

#### 密码错误
```json
{
    "success": false,
    "message": "用户名或密码错误，还剩 4 次尝试机会",
    "data": null
}
```

#### 账户被锁定
```json
{
    "success": false,
    "message": "账户已被锁定，请等待 25 分钟后重试",
    "data": null
}
```

#### 用户不存在
```json
{
    "success": false,
    "message": "用户名或密码错误，还剩 4 次尝试机会",
    "data": null
}
```

#### 账户被禁用
```json
{
    "success": false,
    "message": "账户已被禁用，请联系管理员",
    "data": null
}
```

## 配置参数

### 可配置项
```java
// 最大登录失败次数
private static final int MAX_LOGIN_ATTEMPTS = 5;

// 账户锁定时间（分钟）
private static final int LOCK_DURATION_MINUTES = 30;

// Redis键前缀
private static final String LOGIN_ATTEMPTS_PREFIX = "login_attempts:";
private static final String ACCOUNT_LOCKED_PREFIX = "account_locked:";
```

### 建议配置
- **开发环境**: 可以设置较小的失败次数（如3次）和较短的锁定时间（如10分钟）
- **生产环境**: 建议使用默认配置（5次失败，30分钟锁定）
- **高安全要求**: 可以增加失败次数限制和延长锁定时间

## 安全考虑

### 1. 防暴力破解
- 限制登录尝试次数
- 自动锁定机制
- 时间窗口限制

### 2. 用户体验
- 清晰的错误提示
- 剩余尝试次数显示
- 锁定时间提示

### 3. 系统稳定性
- Redis存储，高性能
- 自动过期机制
- 异常处理完善

## 测试用例

### 1. 正常登录测试
- 使用正确密码登录
- 验证返回JWT令牌
- 验证用户信息正确

### 2. 失败次数限制测试
- 连续输入错误密码
- 验证失败次数递增
- 验证达到限制后账户被锁定

### 3. 账户锁定测试
- 手动锁定账户
- 尝试登录被拒绝
- 验证锁定时间计算

### 4. 成功登录清除测试
- 先进行几次失败尝试
- 使用正确密码登录
- 验证失败次数被清除

## 监控和日志

### 1. 日志记录
```java
log.info("用户 {} 登录成功", username);
log.warn("用户 {} 登录失败，剩余尝试次数: {}", username, remainingAttempts);
log.warn("用户 {} 的账户已被锁定 {} 分钟", username, LOCK_DURATION_MINUTES);
```

### 2. 监控指标
- 登录成功/失败次数
- 账户锁定次数
- 平均登录失败次数

## 故障排除

### 1. 常见问题

#### Q: 用户反映无法登录，提示账户被锁定
**A**: 
1. 检查Redis服务是否正常运行
2. 查看锁定时间是否已过期
3. 可以手动清除锁定状态：`redisTemplate.delete("account_locked:用户名")`

#### Q: 登录失败次数计数不准确
**A**: 
1. 检查Redis连接配置
2. 验证Redis键的过期时间设置
3. 查看是否有多个应用实例共享Redis

#### Q: 锁定时间过长影响用户体验
**A**: 
1. 可以调整`LOCK_DURATION_MINUTES`参数
2. 考虑实现管理员手动解锁功能
3. 可以添加用户自助解锁机制（如邮箱验证）

### 2. 调试方法

#### 查看Redis中的数据
```bash
# 查看失败次数
redis-cli get "login_attempts:用户名"

# 查看锁定状态
redis-cli get "account_locked:用户名"

# 查看过期时间
redis-cli ttl "login_attempts:用户名"
redis-cli ttl "account_locked:用户名"
```

#### 手动清除锁定状态
```java
// 在应用中执行
redisTemplate.delete("login_attempts:用户名");
redisTemplate.delete("account_locked:用户名");
```

## 扩展功能

### 1. 管理员解锁功能
可以添加管理员手动解锁用户账户的功能。

### 2. 用户自助解锁
通过邮箱验证码等方式实现用户自助解锁。

### 3. IP地址限制
可以结合IP地址进行更细粒度的限制。

### 4. 动态配置
可以将限制参数配置化，支持运行时调整。

---

**注意**: 此功能需要Redis服务支持，请确保Redis服务正常运行。 